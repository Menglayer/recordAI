# APY 和时间精确收益率计算指南

## 🎯 新功能说明

MyLedger 现在支持基于精确时间间隔（精确到小时）的收益率计算，包括：
- **期间 ROI**: 扣除现金流后的实际投资回报率
- **APY**: 年化收益率（Annual Percentage Yield）

---

## 📊 计算逻辑

### 1. 期间 ROI（扣除现金流）

**公式**:
```
ROI = (期末净值 - 期初净值 - 净现金流入) / 期初净值 × 100%
```

**说明**:
- 期初净值：第一个快照的总净值
- 期末净值：最后一个快照的总净值
- 净现金流入：期间入金 - 期间出金
- 扣除现金流是为了只计算投资收益，不包括追加投入的影响

**示例**:
```
场景：
- 1月1日快照：$10,000
- 1月3日入金：$5,000
- 1月7日快照：$16,000

计算：
- 期初净值：$10,000
- 期末净值：$16,000
- 净现金流入：$5,000
- ROI = (16,000 - 10,000 - 5,000) / 10,000 × 100% = 10%

解读：虽然净值增加了$6,000，但扣除$5,000入金后，
      实际投资收益是$1,000，收益率10%
```

### 2. APY（年化收益率）

**公式**:
```
APY = ((1 + ROI/100) ^ (8766小时 / 实际小时数) - 1) × 100%
```

**说明**:
- 8766小时 = 365.25天 × 24小时（一年的小时数）
- 实际小时数：精确计算两个快照之间的小时数
- 通过幂运算将短期收益率年化

**示例**:
```
场景（接上例）：
- 时间间隔：6天 = 144小时
- 期间 ROI：10%

计算：
- 年化倍数 = 8766 / 144 = 60.875
- APY = ((1 + 0.10) ^ 60.875 - 1) × 100%
- APY ≈ 39,900% 🚀（极端值，因为时间太短）

警告：短时间内的收益率年化后会非常极端！
      建议至少有 30 天以上的数据才参考 APY
```

---

## ⏰ 时间精确度

### 精确到小时的计算

系统使用快照记录的 `created_at` 字段（记录创建时间）来精确计算时间间隔：

```python
# 示例
快照1: 2026-01-06 09:30:15
快照2: 2026-01-07 15:45:30

时间间隔 = 30小时15分15秒 ≈ 30.25小时
```

**为什么精确到小时很重要？**
1. 短期交易：几小时到几天的交易需要精确时间
2. 高频策略：日内多次交易需要精确收益率
3. 复利计算：时间越精确，年化越准确

---

## 💡 使用建议

### 1. 数据记录频率

| 投资策略 | 推荐频率 | APY 可靠性 |
|---------|---------|-----------|
| 长期持有 | 每周一次 | ⭐⭐⭐⭐⭐ 高 |
| 波段交易 | 每天一次 | ⭐⭐⭐⭐ 较高 |
| 短线交易 | 每次交易后 | ⭐⭐⭐ 中等 |
| 日内交易 | 每小时 | ⭐⭐ 较低（波动大） |

### 2. 现金流记录的重要性

**必须记录的转账**:
- ✅ 每次入金（Deposit）
- ✅ 每次出金（Withdrawal）
- ✅ 即使是小额转账也要记录

**为什么？**
```
错误场景（未记录入金）:
- 期初: $10,000
- 入金: $5,000（忘记记录）
- 期末: $15,000
- 系统计算ROI = 50% ❌（错误！实际没有盈利）

正确场景（记录入金）:
- 期初: $10,000
- 入金: $5,000（已记录）
- 期末: $15,000
- 系统计算ROI = 0% ✓（正确！）
```

### 3. 如何解读 APY

**APY 的合理范围**:
```
数据时长     | APY 范围          | 可信度
-----------|------------------|--------
< 7 天      | ±1000%+          | ⭐ 低
7-30 天     | ±100%            | ⭐⭐ 中
30-90 天    | ±50%             | ⭐⭐⭐ 较高
90-180 天   | ±30%             | ⭐⭐⭐⭐ 高
> 365 天    | 实际年化收益       | ⭐⭐⭐⭐⭐ 很高
```

**注意事项**:
- 时间越短，APY 波动越大
- 一天10%的收益，年化APY会达到3000%+
- 这并不意味着你真能获得3000%的年收益
- APY 只是数学推导，不是承诺或预测

---

## 📊 实际应用示例

### 示例 1: 长期投资者

```
数据：
- 2025-01-01快照: $100,000
- 2025-12-31快照: $120,000
- 期间入金: $10,000
- 期间出金: $5,000

计算：
- 时间间隔: 365天 = 8,760小时
- 净现金流: $10,000 - $5,000 = $5,000
- 期间ROI = (120,000 - 100,000 - 5,000) / 100,000 = 15%
- APY = ((1.15) ^ (8766/8760) - 1) × 100% ≈ 15.01%

解读：
- 实际投资收益: $15,000
- 年化收益率: 15%
- 这是一个可靠的长期收益率
```

### 示例 2: 波段交易者

```
数据：
- 2026-01-01快照: $50,000
- 2026-01-08快照: $52,500
- 期间无转账

计算：
- 时间间隔: 7天 = 168小时
- 期间ROI = (52,500 - 50,000) / 50,000 = 5%
- APY = ((1.05) ^ (8766/168) - 1) × 100% ≈ 392%

解读：
- 实际投资收益: $2,500
- 7天收益率: 5%
- 年化收益率: 392%（假设保持同样收益率）
- ⚠️ 这个APY过于乐观，实际难以维持
```

### 示例 3: 短线交易者

```
数据：
- 今天 09:00快照: $20,000
- 今天 15:00快照: $20,400
- 期间无转账

计算：
- 时间间隔: 6小时
- 期间ROI = (20,400 - 20,000) / 20,000 = 2%
- APY = ((1.02) ^ (8766/6) - 1) × 100% ≈ 无穷大

解读：
- 6小时盈利: $400 (2%)
- ⚠️ APY 计算无意义（时间太短）
- 建议：关注期间 ROI 即可，忽略 APY
```

---

## 🚀 开始使用

### 1. 清空测试数据

```bash
python reset_database.py
```

按提示输入 `DELETE` 和 `YES` 确认。

### 2. 录入真实数据

**第一步：记录初始快照**
- 日期：选择起始日期
- 账户：如 "Binance"
- 资产：如 BTC, ETH, USDT
- 数量：实际持仓

**第二步：记录初始资金**
- 类型：入金
- 金额：初始投入
- 备注：如"初始投资"

**第三步：更新价格**
- 使用价格服务自动更新

**第四步：定期更新**
- 每天/每周记录新快照
- 每次转账立即记录
- 定期更新价格

### 3. 查看收益分析

前往仪表盘查看：
- 总净值
- 投资回报率ROI
- 年化收益率 APY
- 详细的收益分解

---

## ⚠️ 常见问题

### Q1: APY 显示几千甚至几万怎么办？

**A**: 这是正常的！
- 时间间隔太短导致的
- 如果只有 1-7 天的数据，APY 会非常极端
- 解决方案：关注期间 ROI，忽略 APY
- 或者等待 30 天以上再看 APY

### Q2: 为什么我盈利了但 ROI 是负的？

**A**: 可能是忘记记录入金了
- 检查是否所有转账都已记录
- 如果期间有入金但未记录，ROI 会偏低
- 补录转账记录后重新计算

### Q3: 可以修改历史快照吗？

**A**: 可以！
- 相同日期、账户、资产的记录会自动更新
- 直接重新录入即可覆盖旧数据

### Q4: 时间间隔是如何精确计算的？

**A**: 使用记录创建时间
- 每条快照记录都有 `created_at` 时间戳
- 精确到秒，计算时转为小时
- 如果需要，可以手动调整记录时间

---

## 📚 相关文档

- [仪表盘指南](DASHBOARD_GUIDE.md)
- [数据录入指南](DATA_ENTRY_GUIDE.md)
- [价格服务文档](PRICE_SERVICE_DOCS.md)

---

**版本**: v1.4.0 - APY 时间精确计算  
**更新日期**: 2026-01-07  
**功能状态**: ✅ 完全可用

---

**提示**: 数据质量决定分析质量。确保：
1. ✅ 定期记录快照
2. ✅ 及时记录转账
3. ✅ 保持价格更新
4. ✅ 时间跨度足够长（至少30天）
